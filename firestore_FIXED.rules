rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------------------------------------------------------------ *
     * FUNÃ‡Ã•ES AUXILIARES
     * ------------------------------------------------------------------ */
    
    // Verifica se o usuÃ¡rio estÃ¡ autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o usuÃ¡rio Ã© o dono do recurso
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Valida schema de mÃ­dia
    function isValidMedia() {
      let data = request.resource.data;
      return data.keys().hasAll(['title', 'type', 'status', 'userId'])
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 200
        && data.type in ['game', 'anime', 'manga', 'book', 'movie', 'series']
        && data.status in ['completed', 'in-progress', 'dropped', 'planned']
        && data.userId == request.auth.uid;
    }
    
    // Valida schema de notificaÃ§Ã£o
    function isValidNotification() {
      let data = request.resource.data;
      return data.keys().hasAll(['type', 'fromUserId', 'toUserId', 'createdAt'])
        && data.type in ['follow', 'like', 'comment', 'achievement']
        && data.fromUserId == request.auth.uid
        && data.toUserId != request.auth.uid  // NÃ£o pode notificar a si mesmo
        && data.createdAt is timestamp;
    }

    /* ------------------------------------------------------------------ *
     * ðŸ‘¤ PERFIS PÃšBLICOS
     * ------------------------------------------------------------------ */
    match /users/{userId} {
      allow get, list : if isAuthenticated();        // qualquer logado pode ver / listar perfis
      allow create    : if isOwner(userId);          // cria o prÃ³prio perfil
      allow update,
            delete    : if isOwner(userId);          // sÃ³ o dono edita / remove
    }

    /* ------------------------------------------------------------------ *
     * SUBCOLEÃ‡Ã•ES PRIVADAS DO USUÃRIO - MÃDIAS
     * ------------------------------------------------------------------ */
    match /users/{userId}/medias/{mediaId} {
      allow read  : if isOwner(userId);
      allow create: if isOwner(userId) && isValidMedia();
      allow update: if isOwner(userId) && isValidMedia();
      allow delete: if isOwner(userId);
    }

    /* ------------------------------------------------------------------ *
     * OUTRAS SUBCOLEÃ‡Ã•ES PRIVADAS
     * (reviews, milestones, achievements, etc.)
     * ------------------------------------------------------------------ */
    match /users/{userId}/{document=**} {
      allow read, write : if isOwner(userId);   // somente o dono
    }

    /* ------------------------------------------------------------------ *
     * SEGUIDORES / SEGUINDO
     * ------------------------------------------------------------------ */
    match /users/{userId}/followers/{followerId} {
       allow read : if isAuthenticated();
       // Seguidor (followerId) pode se adicionar/remover da lista de seguidores de alguÃ©m
       allow write: if request.auth.uid == followerId;
    }

    match /users/{userId}/following/{followedId} {
       allow read : if isAuthenticated();
       // O usuÃ¡rio (userId) controla quem ele segue
       allow write: if isOwner(userId); 
    }

    /* ------------------------------------------------------------------ *
     * NOTIFICAÃ‡Ã•ES PESSOAIS (COM VALIDAÃ‡ÃƒO)
     * ------------------------------------------------------------------ */
    match /users/{userId}/notifications/{notificationId} {
      allow read, update, delete : if isOwner(userId);
      
      // ValidaÃ§Ã£o rigorosa para criaÃ§Ã£o de notificaÃ§Ãµes
      allow create: if isAuthenticated() 
        && isValidNotification()
        && request.resource.data.toUserId == userId;  // NotificaÃ§Ã£o Ã© para este usuÃ¡rio
    }

    /* ------------------------------------------------------------------ *
     * FEED DE ATIVIDADES GLOBAL
     * ------------------------------------------------------------------ */
    match /activities/{docId} {
       allow read: if isAuthenticated();
       allow create: if isAuthenticated() 
         && request.resource.data.userId == request.auth.uid
         && request.resource.data.keys().hasAll(['userId', 'type', 'createdAt'])
         && request.resource.data.type in ['media_added', 'media_completed', 'review_posted', 'achievement_unlocked'];
       allow update, delete: if request.auth.uid == resource.data.userId;
    }

    /* ------------------------------------------------------------------ *
     * SOLICITAÃ‡Ã•ES DE AMIZADE / SEGUIR
     * ------------------------------------------------------------------ */
    match /followRequests/{requestId} {
      // Quem envia (fromUser) pode criar/deletar.
      // Quem recebe (toUser) pode ler/deletar (aceitar/recusar).
      allow create: if isAuthenticated() 
        && request.resource.data.fromUserId == request.auth.uid
        && request.resource.data.fromUserId != request.resource.data.toUserId;  // NÃ£o pode seguir a si mesmo
      allow read, delete: if isAuthenticated()
        && (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
    }
    
    /* ------------------------------------------------------------------ *
     * RATE LIMITING (COLEÃ‡ÃƒO AUXILIAR)
     * ------------------------------------------------------------------ */
    match /rateLimits/{limitId} {
      allow read, write: if isAuthenticated() && limitId.matches(request.auth.uid + '_.*');
    }
  }
}
