rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ------------------------------------------------------------------ *
     * üë§ PERFIS P√öBLICOS
     * ------------------------------------------------------------------ */
    match /users/{userId} {
      allow get, list : if request.auth != null;        // qualquer logado pode ver / listar perfis
      allow create    : if request.auth.uid == userId;  // cria o pr√≥prio perfil
      allow update,
            delete    : if request.auth.uid == userId;  // s√≥ o dono edita / remove
    }

    /* ------------------------------------------------------------------ *
     * SUBCOLE√á√ïES PRIVADAS DO USU√ÅRIO
     * (medias, reviews, milestones, achievements, etc.)
     * ------------------------------------------------------------------ */
    match /users/{userId}/{document=**} {
      allow read, write : if request.auth.uid == userId;   // somente o dono
    }

    /* ------------------------------------------------------------------ *
     * SEGUIDORES / SEGUINDO
     * ------------------------------------------------------------------ */
    // Meus seguidores: Qualquer um pode ler. 
    // Escrita: Apenas o pr√≥prio seguidor pode se adicionar/remover (se a l√≥gica for essa)
    // OU apenas o dono do perfil (se for aprova√ß√£o).
    // Vamos assumir o padr√£o comum: O usu√°rio X decide seguir Y.
    // X escreve em /users/X/following/Y (PERMITIDO)
    // X escreve em /users/Y/followers/X (PERMITIDO)
    
    match /users/{userId}/followers/{followerId} {
       allow read : if request.auth != null;
       // Seguidor (followerId) pode se adicionar/remover da lista de seguidores de algu√©m
       allow write: if request.auth.uid == followerId;
    }

    match /users/{userId}/following/{followedId} {
       allow read : if request.auth != null;
       // O usu√°rio (userId) controla quem ele segue
       allow write: if request.auth.uid == userId; 
    }

    /* ------------------------------------------------------------------ *
     * NOTIFICA√á√ïES PESSOAIS
     * ------------------------------------------------------------------ */
    match /users/{userId}/notifications/{notificationId} {
      allow read, update, delete : if request.auth.uid == userId;
      // Permitir que OUTROS usu√°rios criem notifica√ß√µes "de systema" ou de intera√ß√£o (like/follow)
      // Isso √© perigoso sem valida√ß√£o de schema, mas necess√°rio sem Cloud Functions.
      // Melhora: garantir que notification.fromUserId == auth.uid
      allow create: if request.auth != null && request.resource.data.fromUserId == request.auth.uid;
    }

    /* ------------------------------------------------------------------ *
     * FEED DE ATIVIDADES GLOBAL
     * ------------------------------------------------------------------ */
    //... (mantendo anterior ou melhorando se necess√°rio)
    match /activities/{docId} {
       allow read: if request.auth != null;
       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
       allow update, delete: if request.auth.uid == resource.data.userId;
    }

    /* ------------------------------------------------------------------ *
     * SOLICITA√á√ïES DE AMIZADE / SEGUIR (Se houver)
     * ------------------------------------------------------------------ */
    match /followRequests/{requestId} {
      // Quem envia (fromUser) pode criar/deletar.
      // Quem recebe (toUser) pode ler/deletar (aceitar/recusar).
      allow create: if request.auth.uid == request.resource.data.fromUserId;
      allow read, delete: if request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUser;
    }
  }
}
